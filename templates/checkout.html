{% extends "base.html" %} 
{% block title %}Abadas | Checkout{% endblock title %} 
{% block content %} 
{% load static %}

<section id="checkout">
    <div class="checkout">

        <div class="checkout-title">
            <h3>Checkout Page</h3>
            <p>You're just a few steps away from completing your purchase. Review your items and ensure all your details are correct before finalizing your order. </p>
        </div>

        <div class="checkout-container">
            <div class="checkout-review">
                <h2>Step 1 - My Cart Checkout - Review Your Cart Items</h2>
                <div>
                    <div class="checkout-list">
                        <ul class="list-group" id="items">
                        
                        </ul>
                    </div>
                    
                    <div class="checkout-total">
                        <h3>Order Summary</h3>
                        <div class="shipping-section">
                            <p>Select shipping:</p>
                            <div class="shipping-options">
                                {% for option in shipping_options %}
                                <label>
                                    <input type="radio" name="shipping_method" value="{{ option.name }}" data-cost="{{ option.cost }}" {% if option.is_default %}checked{% endif %}>
                                    <span>{{ option.name }} ({% if option.cost == 0 %}Free shipping{% else %}${{ option.cost }}{% endif %})</span>
                                </label>
                                {% empty %}
                                <p>No shipping options available. Please contact us.</p>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="cart-subtotal">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping</span>
                                <span id="shipping-cost-display">$0.00</span>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-row total">
                                <span>Total</span>
                                <span id="grand-total">$0.00</span>
                            </div>
                        </div>

                        <p class="summary-note">Enter your details below and place your order. Thank you for using Abadas.</p>
                    </div>
                </div>
            </div>
            <div class="checkout-form">
                <h2>Step 2 - Enter Address & Other Details:</h2>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <input type="hidden" name="itemsJson" id="itemsJson">
                    <input type="hidden" id="amt" name="amt">
                    <input type="hidden" id="shipping_method_input" name="shipping_method">
                    <input type="hidden" id="shipping_cost_input" name="shipping_cost">

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="inputname">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inputEmail4">Email</label>
                            <input type="email" class="form-control email" id="email" name="email" value="{% if user.is_authenticated %}{{user.email}}{% endif %}" required>
                        </div>

                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="inputAddress">Address</label>
                            <input type="text" class="form-control" id="address1" name="address1" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inputAddress">Address line 2 (Optional)</label>
                            <input type="text" class="form-control" placeholder="Apartment, Unit, Suite, or Floor" id="address2" name="address2">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="inputCity">Suburb</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inputState">State</label>
                            <select class="form-control" id="state" name="state" required>
                                <option value="" disabled selected>Select state</option>
                                <option value="ACT">Australian Capital Territory (ACT)</option>
                                <option value="NSW">New South Wales (NSW)</option>
                                <option value="NT">Northern Territory (NT)</option>
                                <option value="QLD">Queensland (QLD)</option>
                                <option value="SA">South Australia (SA)</option>
                                <option value="TAS">Tasmania (TAS)</option>
                                <option value="VIC">Victoria (VIC)</option>
                                <option value="WA">Western Australia (WA)</option>
                            </select>
                        </div>
                        </div>

                     <div class="form-row">
                     <div class="form-group col-md-6">
                            <label for="inputZip">Post Code</label>
                            <input type="number" class="form-control" id="zip_code" name="zip_code" required>
                        </div>
                    <div class="form-group col-md-6">
                        <label for="inputZip">Phone Number</label>
                        <input type="number" class="form-control" id="phone" name="phone" required>
                    </div>
                    <br>

                    <div class="payment-options col-md-12">
                        <h2>Step 3 - Payment</h2>

                        <div class="place-order">
                            <p>Select your preferred payment method:</p>

                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="paypal" required>
                                <div class="payment-content">
                                    <span>PayPal</span>
                                    <img src="{% static '/images/paypal.png' %}" alt="PayPal" height="24">
                                </div>
                            </label>

                            <div id="paypalpay" class="col-lg-12 d-flex justify-content-center">
                                <button id="btn-place-order" type="submit" class="paypal-button"> <img src="{% static '/images/paypal.png' %}" alt="PayPal" height="24"> </button>
                            </div>

                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="card" required>
                                <div class="payment-content">
                                    <span>Credit or Debit Card</span>
                                    <div class="payment-icons">
                                        <img src="{% static '/images/visa.png' %}" alt="Visa">
                                        <img src="{% static '/images/mastercard.png' %}" alt="Mastercard">
                                        <span>+3</span>
                                    </div>
                                </div>
                            </label>
                        
                            <!-- PayPal Buttons -->
                            <div id="paypal-button-container"></div>

                            <label class="payment-option">
                                <input type="radio" name="payment_method" value="payid" required>
                                <div class="payment-content">
                                    <span>Pay ID</span>
                                </div>
                            </label>

                            <div id="payid-section" style="display:none;">
                                <div class="payid-info" style="background:#f7f7f7;border:1px solid #e2e2e2;border-radius:6px;padding:12px;margin:10px 0;">
                                    <p>Please send the payment to the PAY ID listed below:</p>
                                    <p><strong>Account Name:</strong> A. Bushra<br>
                                    <strong>PayID:</strong> 0432078656 </p>
                                    <p>To confirm your payment, upload a screenshot of your transfer receipt after placing the order.</p>
                                    <p>If you have trouble, contact us via Facebook or email.</p>
                                </div>
                                <div class="form-group">
                                    <label for="payid_proof">Upload payment screenshot</label>
                                    <input type="file" id="payid_proof" name="payid_proof" accept="image/*">
                                </div>
                                <div class="payid-button d-flex justify-content-center">
                                    <button id="btn-payid-submit" type="submit" class="" style="display:none;">Place Order</button>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
</section>


<script>
    document.addEventListener('DOMContentLoaded', function() {

        const paypalRadio = document.querySelector('input[value="paypal"]');
        const cardRadio = document.querySelector('input[value="card"]');
        const payidRadio = document.querySelector('input[value="payid"]');
        const shippingRadios = document.querySelectorAll('input[name="shipping_method"]');
        

        // Disable the PayPal button initially
        const paypalButtonContainer = document.getElementById('paypal-button-container');
        paypalButtonContainer.style.pointerEvents = "none"; // Disable clicks
        paypalButtonContainer.style.opacity = "0.5"; // Visual indicator of disabled state
        paypalButtonContainer.style.display = "none"; // Visual indicator of disabled state


        const paypalpay = document.getElementById('btn-place-order');
        paypalpay.style.pointerEvents = "none";
        paypalpay.style.opacity = "0.5";
        paypalpay.style.display = "none";

        const payidSection = document.getElementById('payid-section');
        const payidBtn = document.getElementById('btn-payid-submit');
        if (payidBtn) {
            payidBtn.style.pointerEvents = "none";
            payidBtn.style.opacity = "0.5";
            payidBtn.style.display = "none";
        }

        // Shipping helpers
        function getSelectedShipping() {
            let selected = document.querySelector('input[name="shipping_method"]:checked');
            const cost = selected ? parseFloat(selected.getAttribute('data-cost')) : 0;
            const method = selected ? selected.value : '';
            return { cost, method };
        }

        function updateTotals() {
            const subtotalEl = document.getElementById('cart-subtotal');
            const shippingEl = document.getElementById('shipping-cost-display');
            const grandTotalEl = document.getElementById('grand-total');
            const amountHidden = document.getElementById('amt');
            const shippingMethodHidden = document.getElementById('shipping_method_input');
            const shippingCostHidden = document.getElementById('shipping_cost_input');

            const subtotal = window.__checkoutSubtotal || 0;
            const { cost, method } = getSelectedShipping();
            const grand = (subtotal + cost).toFixed(2);

            if (subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            if (shippingEl) shippingEl.textContent = `$${cost.toFixed(2)}`;
            if (grandTotalEl) grandTotalEl.textContent = `$${grand}`;
            if (amountHidden) amountHidden.value = grand;
            if (shippingMethodHidden) shippingMethodHidden.value = method;
            if (shippingCostHidden) shippingCostHidden.value = cost.toFixed(2);
        }

        // Form validation function
        function validateForm() {
            const name = document.getElementById('name').value.trim();
            const email = document.querySelector('.email').value.trim();
            const address1 = document.getElementById('address1').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            const zipCode = document.getElementById('zip_code').value.trim();
            const phone = document.getElementById('phone').value.trim();

            // Check if all required fields are filled
            return name && email && address1 && city && state && zipCode && phone;
        }

        // Update totals when shipping changes
        shippingRadios.forEach(r => r.addEventListener('change', updateTotals));

        // Initialize totals on load
        updateTotals();

        // Enable PayPal button when the form is valid
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                if (validateForm()) {
                    
                    if (cardRadio.checked) {
                        paypalButtonContainer.style.pointerEvents = "auto";
                        paypalButtonContainer.style.opacity = "1";
                        paypalButtonContainer.style.display = "block";
                        paypalpay.style.display = "none";
                        payidSection.style.display = "none";
                        if (payidBtn) payidBtn.style.display = "none";
                    }

                    if (paypalRadio.checked) {
                        paypalpay.style.pointerEvents = "auto";
                        paypalpay.style.opacity = "1";
                        paypalpay.style.display = "block";
                        paypalButtonContainer.style.display = "none";
                        payidSection.style.display = "none";
                        if (payidBtn) payidBtn.style.display = "none";
                    }
                    
                    if (payidRadio && payidRadio.checked) {
                        payidSection.style.display = "block";
                        paypalButtonContainer.style.display = "none";
                        paypalpay.style.display = "none";
                        if (payidBtn) {
                            payidBtn.style.pointerEvents = "auto";
                            payidBtn.style.opacity = "1";
                            payidBtn.style.display = "inline-block";
                        }
                    }
                        
                } else {
                    paypalButtonContainer.style.pointerEvents = "none";
                    paypalButtonContainer.style.opacity = "0.5";

                    paypalpay.style.pointerEvents = "none";
                    paypalpay.style.opacity = "0.5";
                    if (payidBtn) {
                        payidBtn.style.pointerEvents = "none";
                        payidBtn.style.opacity = "0.5";
                    }
                }
            });
        });

        paypal.Buttons({
            
            fundingSource: paypal.FUNDING.CARD, // This ensures only the card button is rendered.

            createOrder: function (data, actions) {

                if (!validateForm()) {
                    alert('Please fill out the form completely before proceeding to payment.');
                    return;
                }

                return actions.order.create({
                    application_context: {
                        shipping_preference: 'NO_SHIPPING',
                        locale: 'en-AU',
                        brand_name: 'Abadas'
                    },
                    purchase_units: [{
                        amount: {
                            value: document.getElementById('amt').value,
                            currency_code: 'AUD'
                        },
                    }],
                });
            },
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    console.log("Transaction completed by " + details.payer.name.given_name);
        
                    // Prepare the form data for submission
                    const formData = new FormData();
                    formData.append('transaction_id', details.id);
                    formData.append('items_json', document.getElementById('itemsJson').value);
                    formData.append('amount', document.getElementById('amt').value);
                    formData.append('shipping_method', document.getElementById('shipping_method_input').value);
                    formData.append('shipping_cost', document.getElementById('shipping_cost_input').value);
                    formData.append('name', document.getElementById('name').value);
                    formData.append('email', document.querySelector('.email').value);
                    formData.append('address1', document.getElementById('address1').value);
                    formData.append('address2', document.getElementById('address2').value);
                    formData.append('city', document.getElementById('city').value);
                    formData.append('state', document.getElementById('state').value);
                    formData.append('zip_code', document.getElementById('zip_code').value);
                    formData.append('phone', document.getElementById('phone').value);
                    formData.append('amount_paid', details.purchase_units[0].amount.value);
        
                    // Send data to the backend
                    fetch('/shop/payment/success/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                    })
                    .then(response => {
                        if (response.ok) {
                            // Payment processed successfully, redirect to success page
                            window.location.href = '/shop/payment/success/';
                        } else {
                            alert('Error saving the order. Please contact support.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Something went wrong. Please try again.');
                    });
                });
            },
            onCancel: function (data) {
                alert('Payment cancelled.');
                window.location.href = '/shop/payment/cancel/';
            },
            onError: function (err) {
                console.error('Payment error:', err);
                alert('Something went wrong with the payment. Please try again.');
            }
        }).render('#paypal-button-container');
        
    });
</script>



{% endblock content %}
