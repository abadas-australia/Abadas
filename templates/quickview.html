{% extends "base.html" %}
{% block title %} Abadas | Quick View {% endblock title %}
{% block content %}
{% load static %}

<style>
    /* Quick-view image zoom */
    .quick-view .zoomable { position: relative; overflow: hidden; }
    .quick-view .zoomable img { transition: transform 0.06s ease; will-change: transform; display: block; }
    .quick-view .zoomable { cursor: zoom-out; }
    .quick-view .zoomable.is-zoomed { cursor: zoom-out; }
</style>

<section id="quick-view">
    <div class="quick-view">
        <div class="quick-view-images">
            <div class="quick-view-images-top">
                <div class="zoomable"><img id="imagepr{{product.id}}" src="{{ product.product_image_1.url }}" alt="{{ product.product_name }}"></div>
                <div class="zoomable"><img src="{{ product.product_image_2.url }}" alt="{{ product.product_name }}"></div>
            </div>

            <div class="quick-view-images-bottom">
                <div class="zoomable"><img src="{{ product.product_image_3.url }}" alt="{{ product.product_name }}"></div>
                <div class="zoomable"><img src="{{ product.product_image_4.url }}" alt="{{ product.product_name }}"></div>
                <div class="zoomable"><img src="{{ product.product_image_5.url }}" alt="{{ product.product_name }}"></div>
            </div>
        </div>

        <div class="quick-view-info">
            <h5 class="card-title mt-2" id="namepr{{product.id}}">{{product.product_name}}</h5>
            <h6 class="card-title mb-3">
                $ <span id="pricepr{{product.id}}">{{product.product_price}}</span>
            </h6>
            <div class="quick-view-info-description">{{ product.product_desc|safe }}</div>

            <div class="quick-view-info-option">
                <div class="quick-view-info-option-section">
                    <p>Color</p>
                    <select id="color">
                        <option value="">Choose an option</option>
                        {% for color in colors %}
                        <option value="{{ color }}">{{ color }}</option>
                        {% endfor %}
                    </select>
                </div>
            
                <div class="quick-view-info-option-section">
                    <p>Size</p>
                    <select id="size">
                        <option value="">Choose an option</option>
                        {% for size in sizes %}
                        <option value="{{ size }}">{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="quick-view-info-cart">
                {% if product.stock_status == 'out_of_stock' %}
                        <div id="divpr{{product.id}}" class="divpr">
                            <button id="pr{{product.id}}" class="cart" disabled style="background-color: #6c757d; cursor: not-allowed;">
                              OUT OF STOCK <i class="fa-solid fa-ban"></i>
                            </button>
                        </div>
                {% else %}
                    <div class="quick-view-info-cart-quantity">
                        <button id="decreasepr{{product.id}}" class="quick-view-info-cart-quantity-button"><span>-</span></button>
                        <input type="number" class="quantity" id="quantitypr{{product.id}}" value="1" min="1">
                        <button id="increasepr{{product.id}}" class="quick-view-info-cart-quantity-button"><span>+</span></button>
                    </div>
                    
                    <div id="divpr{{product.id}}" class="divpr">
                        <button id="pr{{product.id}}" class="cart">
                          ADD TO CART <i class="fa-solid fa-cart-shopping"></i>
                        </button>
                    </div>
                {% endif %}
            </div>

            <p class="quick-view-info-features">Product Id: <span>{{ product.id }}</span></p>
            <p class="quick-view-info-features">Category: <span>{{ product.product_category.name }}</span></p>
        </div>
    </div>
</section>

<script>
    // Dynamically filter sizes by selected color and show stock qty if provided
    (function(){
        var optionsByColor = {{ variant_options_by_color_json|safe }};
        var quantities = {{ variant_quantities_json|safe }};
        window.__VARIANT_QTY__ = quantities;
        var colorSel = document.getElementById('color');
        var sizeSel = document.getElementById('size');
        var qtyInput = document.getElementById('quantitypr{{product.id}}');
        function refreshSizes(){
            if(!optionsByColor || !colorSel) return;
            var selected = colorSel.value;
            if(!selected || !optionsByColor[selected]) return;
            var sizes = optionsByColor[selected];
            var current = sizeSel.value;
            sizeSel.innerHTML = '<option value="">Choose an option</option>';
            sizes.forEach(function(sz){
                var label = sz;
                var key = selected + '|' + sz;
                var opt = document.createElement('option');
                opt.value = sz;
                opt.textContent = label;
                sizeSel.appendChild(opt);
            });
            if (sizes.includes(current)) sizeSel.value = current; else sizeSel.value = '';
        }
        if(colorSel) colorSel.addEventListener('change', refreshSizes);
        document.addEventListener('DOMContentLoaded', refreshSizes);

        // Prevent adding more than available per variant
        document.addEventListener('click', function(e){
            var target = e.target;
            if (target && target.id === 'pr{{product.id}}') {
                var c = colorSel.value;
                var s = sizeSel.value;
                if (!c || !s) return; // global JS will alert
                var key = c + '|' + s;
                var available = quantities[key];
                var desired = qtyInput ? parseInt(qtyInput.value || '1') : 1;
                if (typeof available === 'number' && desired > available) {
                    e.stopPropagation();
                    e.preventDefault();
                    alert('Only ' + available + ' in stock for this variant.');
                    if (qtyInput) qtyInput.value = available;
                }
            }
        }, true);
    })();
</script>


<script>
    // Lightweight zoom-on-hover that follows cursor; no external dependencies
    (function(){
        if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) return; // skip on touch
        function attachZoom(container){
            if(!container) return;
            var img = container.querySelector('img');
            if(!img) return;
            var scale = 2; // zoom factor
            function onEnter(){ container.classList.add('is-zoomed'); }
            function onLeave(){ container.classList.remove('is-zoomed'); img.style.transform = 'none'; img.style.transformOrigin = 'center center'; }
            function onMove(e){
                if(!container.classList.contains('is-zoomed')) return;
                var rect = img.getBoundingClientRect();
                var x = ((e.clientX - rect.left) / rect.width) * 100;
                var y = ((e.clientY - rect.top) / rect.height) * 100;
                img.style.transformOrigin = x + '% ' + y + '%';
                img.style.transform = 'scale(' + scale + ')';
            }
            container.addEventListener('mouseenter', onEnter);
            container.addEventListener('mouseleave', onLeave);
            container.addEventListener('mousemove', onMove);
        }
        document.addEventListener('DOMContentLoaded', function(){
            var zoomables = document.querySelectorAll('.quick-view .zoomable');
            zoomables.forEach(attachZoom);
        });
    })();
</script>

{% endblock content %}
